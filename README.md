# file-checker
Сервис для генерации набора файлов, их анализа и записи содержимого в БД для хранения

# Установка

Для установки выполнить команду внутри установленного вирутального окружения:

```bash
pip3 install -r requirements.txt
```

# Использование

Сервис состоит из набора скриптов, каждый из которых выполняет свою специфическую задачу. Параметры скриптов можно задать параметрами командной строки


## Генератор 

Генерирует набор файлов случайного размера в заданной директории.
Внутри каждого файла содержатся строки вида “123 12345”. Первое число – идентификатор потребителя, второе - количество потреблённого ресурса. В качестве разделителя используется пробел.

Для запуска необходимо запустить скрипт generate.py

Параметры запуска:

```bash
usage: generate.py [-h] [-c COUNT] [-l LINES] [-k MAX_CONSUMER_ID] [-r MAX_CONSUMER_RES_VALUE] [-f FOLDER]

Утилита для генерации случайных файлов

optional arguments:
  -h, --help            show this help message and exit
  -c COUNT, --count COUNT
                        Число сгенерированных файлов
  -l LINES, --lines LINES
                        Максимальная количество строк файла
  -k MAX_CONSUMER_ID, --max_consumer_id MAX_CONSUMER_ID
                        Максимальный идентификатор потребителя
  -r MAX_CONSUMER_RES_VALUE, --max_consumer_res_value MAX_CONSUMER_RES_VALUE
                        Максимальное назначение ресурса для потребителя
  -f FOLDER, --folder FOLDER
                        Директория для хранения сгенерированных файлов

```

## Обработка файлов

Сервис в цикле запускает процедуру анализа файлов. Цикл состоит из следующих операций:
* получает список файлов директории
* для каждого из файла запускается дочерний процесс, который берет заданное число строк из файла и возвращает в родительский процесс словарь, построенный на основе считанных строк
* полученные словари сохраняются в БД
* в случае успешной операции записи словаря в БД создаются дочерние процессы для удаления "обработанных" строк из файла. В случае, если в файле не осталось строк, файл удаляется

Для запуска сервиса необходимо запустить скрипт file_checker.py

```bash
usage: file_checker.py [-h] [-d DIRECTORY] [-t TIMER] [-c CHUNK]

Сервис для анализа содержимого файлов

optional arguments:
  -h, --help            show this help message and exit
  -d DIRECTORY, --directory DIRECTORY
                        Путь к директории со файлами для анализа
  -t TIMER, --timer TIMER
                        Период проверки файлов
  -c CHUNK, --chunk CHUNK
                        Число строк, которые вычитываем за раз
                        
```

Обмен данными между родительским процессом и дочерними процессами осуществляется через механизм каналов Linux ( pipe ). 

## Хранение результатов в БД

Для хранения полученных результатов используется БД SQLite.
Данные хранятся в таблице consumer

<img width="289" alt="Снимок экрана 2021-03-16 в 12 12 34" src="https://user-images.githubusercontent.com/1698696/111284416-266bbd00-8651-11eb-80c2-bb1181ab017e.png">
